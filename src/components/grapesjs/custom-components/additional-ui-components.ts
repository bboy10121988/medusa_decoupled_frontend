/**
 * È°çÂ§ñ UI ÁµÑ‰ª∂ÔºöAccordion Âíå Tabs
 * Ë£úÂÖÖÈÄ≤Èöé UI ÁµÑ‰ª∂Â∫´
 */

/**
 * Ë®ªÂÜäÈ°çÂ§ñÁöÑ UI ÁµÑ‰ª∂Âà∞ GrapesJS
 */
export const registerAdditionalUIComponents = (editor: any) => {
  console.log('üé® Ë®ªÂÜäÈ°çÂ§ñ UI ÁµÑ‰ª∂ (Accordion & Tabs)...');

  // 4. Accordion Êë∫ÁñäÈù¢ÊùøÁµÑ‰ª∂
  editor.Components.addType('accordion-component', {
    model: {
      defaults: {
        tagName: 'div',
        type: 'accordion-component',
        name: 'Êë∫ÁñäÈù¢Êùø',
        draggable: true,
        droppable: false,
        traits: [
          {
            type: 'text',
            name: 'accordionTitle',
            label: 'Èù¢ÊùøÊ®ôÈ°å',
            changeProp: true,
            value: 'Êë∫ÁñäÈù¢ÊùøÊ®ôÈ°å'
          },
          {
            type: 'textarea',
            name: 'accordionContent',
            label: 'Èù¢ÊùøÂÖßÂÆπ',
            changeProp: true,
            value: 'ÈÄôË£°ÊòØÊë∫ÁñäÈù¢ÊùøÁöÑÂÖßÂÆπ...'
          },
          {
            type: 'color',
            name: 'headerColor',
            label: 'Ê®ôÈ†≠È°èËâ≤',
            changeProp: true,
            value: '#f8f9fa'
          },
          {
            type: 'color',
            name: 'borderColor',
            label: 'ÈÇäÊ°ÜÈ°èËâ≤',
            changeProp: true,
            value: '#dee2e6'
          },
          {
            type: 'checkbox',
            name: 'defaultOpen',
            label: 'È†êË®≠Â±ïÈñã',
            changeProp: true,
            value: false
          },
          {
            type: 'checkbox',
            name: 'showIcon',
            label: 'È°ØÁ§∫ÁÆ≠È†≠',
            changeProp: true,
            value: true
          }
        ],
        style: {
          'width': '100%',
          'max-width': '600px',
          'margin': '20px 0'
        }
      }
    },
    view: {
      onRender(this: any) {
        this.updateAccordion();
      },
      
      updateAccordion(this: any) {
        const model = this.model;
        const accordionTitle = model.get('accordionTitle') || 'Êë∫ÁñäÈù¢ÊùøÊ®ôÈ°å';
        const accordionContent = model.get('accordionContent') || 'ÈÄôË£°ÊòØÊë∫ÁñäÈù¢ÊùøÁöÑÂÖßÂÆπ...';
        const headerColor = model.get('headerColor') || '#f8f9fa';
        const borderColor = model.get('borderColor') || '#dee2e6';
        const defaultOpen = model.get('defaultOpen');
        const showIcon = model.get('showIcon');

        // Áî® DOM Êìç‰ΩúÂª∫Á´ã Accordion
        this.el.innerHTML = '';
        
        const container = document.createElement('div');
        container.className = 'accordion-container';
        
        Object.assign(container.style, {
          width: '100%',
          border: `1px solid ${borderColor}`,
          borderRadius: '8px',
          overflow: 'hidden'
        });

        // Accordion Ê®ôÈ†≠
        const header = document.createElement('div');
        header.className = 'accordion-header';
        
        Object.assign(header.style, {
          background: headerColor,
          padding: '16px 20px',
          cursor: 'pointer',
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          borderBottom: `1px solid ${borderColor}`,
          transition: 'all 0.3s ease',
          userSelect: 'none'
        });

        const titleEl = document.createElement('h6');
        titleEl.textContent = accordionTitle;
        titleEl.style.margin = '0';
        titleEl.style.fontSize = '16px';
        titleEl.style.fontWeight = '500';

        header.appendChild(titleEl);

        if (showIcon) {
          const iconEl = document.createElement('span');
          iconEl.className = 'accordion-icon';
          iconEl.innerHTML = '‚ñº';
          iconEl.style.fontSize = '12px';
          iconEl.style.transition = 'transform 0.3s ease';
          iconEl.style.transform = defaultOpen ? 'rotate(180deg)' : 'rotate(0deg)';
          header.appendChild(iconEl);
        }

        // Accordion ÂÖßÂÆπ
        const content = document.createElement('div');
        content.className = 'accordion-content';
        content.innerHTML = accordionContent;
        
        Object.assign(content.style, {
          padding: defaultOpen ? '20px' : '0 20px',
          maxHeight: defaultOpen ? '1000px' : '0',
          overflow: 'hidden',
          transition: 'all 0.3s ease',
          lineHeight: '1.6',
          color: '#495057'
        });

        // Ê∑ªÂä†ÈªûÊìä‰∫ã‰ª∂
        let isOpen = defaultOpen;
        header.addEventListener('click', () => {
          isOpen = !isOpen;
          
          if (isOpen) {
            content.style.maxHeight = '1000px';
            content.style.padding = '20px';
            if (showIcon) {
              const icon = header.querySelector('.accordion-icon') as HTMLElement;
              if (icon) icon.style.transform = 'rotate(180deg)';
            }
          } else {
            content.style.maxHeight = '0';
            content.style.padding = '0 20px';
            if (showIcon) {
              const icon = header.querySelector('.accordion-icon') as HTMLElement;
              if (icon) icon.style.transform = 'rotate(0deg)';
            }
          }
        });

        container.appendChild(header);
        container.appendChild(content);
        this.el.appendChild(container);
      }
    }
  });

  // 5. Tabs È†ÅÁ±§ÁµÑ‰ª∂
  editor.Components.addType('tabs-component', {
    model: {
      defaults: {
        tagName: 'div',
        type: 'tabs-component',
        name: 'È†ÅÁ±§ÁµÑ‰ª∂',
        draggable: true,
        droppable: false,
        traits: [
          {
            type: 'text',
            name: 'tab1Title',
            label: 'È†ÅÁ±§1Ê®ôÈ°å',
            changeProp: true,
            value: 'È†ÅÁ±§‰∏Ä'
          },
          {
            type: 'textarea',
            name: 'tab1Content',
            label: 'È†ÅÁ±§1ÂÖßÂÆπ',
            changeProp: true,
            value: 'ÈÄôÊòØÁ¨¨‰∏ÄÂÄãÈ†ÅÁ±§ÁöÑÂÖßÂÆπ...'
          },
          {
            type: 'text',
            name: 'tab2Title',
            label: 'È†ÅÁ±§2Ê®ôÈ°å',
            changeProp: true,
            value: 'È†ÅÁ±§‰∫å'
          },
          {
            type: 'textarea',
            name: 'tab2Content',
            label: 'È†ÅÁ±§2ÂÖßÂÆπ',
            changeProp: true,
            value: 'ÈÄôÊòØÁ¨¨‰∫åÂÄãÈ†ÅÁ±§ÁöÑÂÖßÂÆπ...'
          },
          {
            type: 'text',
            name: 'tab3Title',
            label: 'È†ÅÁ±§3Ê®ôÈ°å',
            changeProp: true,
            value: 'È†ÅÁ±§‰∏â'
          },
          {
            type: 'textarea',
            name: 'tab3Content',
            label: 'È†ÅÁ±§3ÂÖßÂÆπ',
            changeProp: true,
            value: 'ÈÄôÊòØÁ¨¨‰∏âÂÄãÈ†ÅÁ±§ÁöÑÂÖßÂÆπ...'
          },
          {
            type: 'color',
            name: 'activeColor',
            label: 'ÂïüÁî®È°èËâ≤',
            changeProp: true,
            value: '#007bff'
          },
          {
            type: 'color',
            name: 'inactiveColor',
            label: 'ÈùûÂïüÁî®È°èËâ≤',
            changeProp: true,
            value: '#6c757d'
          },
          {
            type: 'select',
            name: 'defaultTab',
            label: 'È†êË®≠È†ÅÁ±§',
            changeProp: true,
            options: [
              { value: '1', name: 'È†ÅÁ±§1' },
              { value: '2', name: 'È†ÅÁ±§2' },
              { value: '3', name: 'È†ÅÁ±§3' }
            ],
            value: '1'
          }
        ],
        style: {
          'width': '100%',
          'max-width': '800px',
          'margin': '20px 0'
        }
      }
    },
    view: {
      onRender(this: any) {
        this.updateTabs();
      },
      
      updateTabs(this: any) {
        const model = this.model;
        const tab1Title = model.get('tab1Title') || 'È†ÅÁ±§‰∏Ä';
        const tab1Content = model.get('tab1Content') || 'ÈÄôÊòØÁ¨¨‰∏ÄÂÄãÈ†ÅÁ±§ÁöÑÂÖßÂÆπ...';
        const tab2Title = model.get('tab2Title') || 'È†ÅÁ±§‰∫å';
        const tab2Content = model.get('tab2Content') || 'ÈÄôÊòØÁ¨¨‰∫åÂÄãÈ†ÅÁ±§ÁöÑÂÖßÂÆπ...';
        const tab3Title = model.get('tab3Title') || 'È†ÅÁ±§‰∏â';
        const tab3Content = model.get('tab3Content') || 'ÈÄôÊòØÁ¨¨‰∏âÂÄãÈ†ÅÁ±§ÁöÑÂÖßÂÆπ...';
        const activeColor = model.get('activeColor') || '#007bff';
        const inactiveColor = model.get('inactiveColor') || '#6c757d';
        const defaultTab = model.get('defaultTab') || '1';

        // Áî® DOM Êìç‰ΩúÂª∫Á´ã Tabs
        this.el.innerHTML = '';
        
        const container = document.createElement('div');
        container.className = 'tabs-container';
        container.style.width = '100%';

        // Tab Â∞éËà™
        const tabNav = document.createElement('div');
        tabNav.className = 'tab-nav';
        
        Object.assign(tabNav.style, {
          display: 'flex',
          borderBottom: '2px solid #e9ecef',
          marginBottom: '20px'
        });

        // ÂâµÂª∫È†ÅÁ±§ÊåâÈàï
        const tabs = [
          { id: '1', title: tab1Title, content: tab1Content },
          { id: '2', title: tab2Title, content: tab2Content },
          { id: '3', title: tab3Title, content: tab3Content }
        ];

        const tabButtons: HTMLElement[] = [];
        const tabContents: HTMLElement[] = [];

        tabs.forEach(tab => {
          // È†ÅÁ±§ÊåâÈàï
          const tabBtn = document.createElement('button');
          tabBtn.className = 'tab-button';
          tabBtn.textContent = tab.title;
          tabBtn.setAttribute('data-tab', tab.id);
          
          const isActive = tab.id === defaultTab;
          Object.assign(tabBtn.style, {
            background: 'none',
            border: 'none',
            padding: '12px 24px',
            cursor: 'pointer',
            fontSize: '14px',
            fontWeight: '500',
            color: isActive ? activeColor : inactiveColor,
            borderBottom: `2px solid ${isActive ? activeColor : 'transparent'}`,
            transition: 'all 0.3s ease'
          });

          tabButtons.push(tabBtn);
          tabNav.appendChild(tabBtn);

          // È†ÅÁ±§ÂÖßÂÆπ
          const tabContent = document.createElement('div');
          tabContent.className = 'tab-content';
          tabContent.innerHTML = tab.content;
          tabContent.setAttribute('data-tab-content', tab.id);
          
          Object.assign(tabContent.style, {
            display: isActive ? 'block' : 'none',
            padding: '20px 0',
            lineHeight: '1.6',
            color: '#495057'
          });

          tabContents.push(tabContent);
        });

        // Ê∑ªÂä†È†ÅÁ±§ÂàáÊèõ‰∫ã‰ª∂
        const handleTabClick = (targetTab: string) => {
          // Êõ¥Êñ∞ÊåâÈàïÊ®£Âºè
          tabButtons.forEach(b => {
            b.style.color = inactiveColor;
            b.style.borderBottomColor = 'transparent';
          });
          
          const activeBtn = tabButtons.find(b => b.getAttribute('data-tab') === targetTab);
          if (activeBtn) {
            activeBtn.style.color = activeColor;
            activeBtn.style.borderBottomColor = activeColor;
          }
          
          // Êõ¥Êñ∞ÂÖßÂÆπÈ°ØÁ§∫
          tabContents.forEach(content => {
            content.style.display = 'none';
          });
          
          const targetContent = tabContents.find(content => 
            content.getAttribute('data-tab-content') === targetTab
          );
          if (targetContent) {
            targetContent.style.display = 'block';
          }
        };

        tabButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            const targetTab = btn.getAttribute('data-tab');
            if (targetTab) {
              handleTabClick(targetTab);
            }
          });
        });

        container.appendChild(tabNav);
        tabContents.forEach(content => {
          container.appendChild(content);
        });

        this.el.appendChild(container);
      }
    }
  });

  // Ê∑ªÂä†ÁµÑ‰ª∂Âà∞ Block Manager
  editor.BlockManager.add('accordion-component', {
    label: 'Êë∫ÁñäÈù¢Êùø',
    category: 'ÈÄ≤Èöé UI',
    media: '<i class="fa fa-list-ul"></i>',
    content: { type: 'accordion-component' }
  });

  editor.BlockManager.add('tabs-component', {
    label: 'È†ÅÁ±§ÁµÑ‰ª∂',
    category: 'ÈÄ≤Èöé UI',
    media: '<i class="fa fa-folder-open"></i>',
    content: { type: 'tabs-component' }
  });

  console.log('‚úÖ È°çÂ§ñ UI ÁµÑ‰ª∂ (Accordion & Tabs) Ë®ªÂÜäÂÆåÊàê');
};